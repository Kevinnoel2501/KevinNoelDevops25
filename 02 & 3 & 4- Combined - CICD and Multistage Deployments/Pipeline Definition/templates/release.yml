parameters:
  environment: ''                 # environment name (e.g. dev, stg, prod)
  appServiceName: 'test-app'      # base App Service name
  resourceGroupName: ''           # Resource Group name
  keyVaultName: ''                # Key Vault name
  secretName: ''                  # Secret name to fetch
  sp: ''

steps:
  - download: current
    artifact: drop

  # Fetch secret from Key Vault using az cli
  - task: AzureCLI@2
    displayName: 'Fetch secret from Key Vault'
    inputs:
      azureSubscription: '${{ parameters.sp }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Fetching secret..."
        secretValue=$(az keyvault secret show \
          --vault-name ${{ parameters.keyVaultName }} \
          --name ${{ parameters.secretName }} \
          --query value -o tsv)

        echo "##vso[task.setvariable variable=StorageAccountConnStr;issecret=true]$secretValue"

  # Deploy the ZIP package
  - task: AzureWebApp@1
    displayName: 'Deploy to Azure App Service'
    inputs:
      azureSubscription: '${{ parameters.sp }}'
      appName: '${{ parameters.environment }}-${{ parameters.appServiceName }}'
      resourceGroupName: ${{ parameters.resourceGroupName }}
      package: '$(Pipeline.Workspace)/drop/*.zip'

  # Update App Service settings with the secret
  - task: AzureAppServiceSettings@1
    displayName: 'Configure App Settings'
    inputs:
      azureSubscription: '${{ parameters.sp }}'
      appName: '${{ parameters.environment }}-${{ parameters.appServiceName }}'
      resourceGroupName: ${{ parameters.resourceGroupName }}
      appSettings: |
        [
          {
            "name": "StorageAccountConnStr",
            "value": "$(StorageAccountConnStr)"
          }
        ]

